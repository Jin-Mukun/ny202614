<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NY2026十四班逆天视频</title>
    <style>
        /* 基本样式 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        header {
            background-color: #333;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 可编辑文字区域 */
        .editable-section {
            background-color: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* 视频播放区域 */
        .video-player {
            background-color: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .video-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
        }

        video {
            width: 100%;
            max-width: 800px;
            display: block;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #000;
        }

        /* 视频列表 */
        .video-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
        }

        .video-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 300px;
            cursor: pointer;
            transition: transform 0.2s ease;
            will-change: transform;
            backface-visibility: hidden;
        }

        .video-item:hover {
            transform: translateY(-5px);
        }

        .video-item-title {
            font-size: 18px;
            margin: 10px 0;
            color: #333;
        }

        /* 加载状态样式 */
        .loading-status {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }

        .loading-bar {
            width: 100%;
            height: 4px;
            background-color: #f0f0f0;
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .loading-progress {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            color: #666;
        }
    </style>
</head>

<body>
    <!-- 顶部标题 -->
    <header>
        <h1>NY2026十四班逆天视频网站</h1>
    </header>

    <div class="container">
        <!-- 可编辑文字区域 -->
        <section class="editable-section">
            <h2>欢迎来到NY2026十四班官方网站</h2>
            <p>这里有逆天的超人视频。</p>
            <!-- 你可以直接编辑这里的文字内容 -->
        </section>

        <!-- 视频播放器 -->
        <section class="video-player">
            <h2 class="video-title" id="current-video-title">正在准备…</h2>
            <video id="main-video" controls controlsList="nodownload" preload="auto" playsinline
                oncontextmenu="return false;">
                <source src="videos/video1.mp4" type="video/mp4">
                您的浏览器不支持视频播放，请使用现代浏览器。
            </video>
            <div class="loading-status" id="loading-status">
                准备就绪
            </div>
            <div class="loading-bar" id="loading-bar" style="display: none;">
                <div class="loading-progress" id="loading-progress"></div>
            </div>
        </section>

        <!-- 视频列表 -->
        <section>
            <h2>视频列表</h2>
            <div class="video-list">
                <!-- 视频1 -->
                <div class="video-item" onclick="loadAndPlayVideo('videos/video1.mp4')">
                    <h3 class="video-item-title">v1</h3>
                    <p>这是原始鼻祖，也是目前的巅峰之作<br>(拍摄于2025.01.06)</p>
                </div>

                <!-- 视频2 -->
                <div class="video-item" onclick="loadAndPlayVideo('videos/video2.mp4')">
                    <h3 class="video-item-title">v2</h3>
                    <p>水哥...<br>(拍摄于2025.11.11)</p>
                </div>

                <!-- 视频3 -->
                <div class="video-item" onclick="loadAndPlayVideo('videos/video3.mp4')">
                    <h3 class="video-item-title">v3</h3>
                    <p>谁说战神超不了简？<br>(拍摄于2025.12.09)</p>
                </div>

                <!-- 视频4 -->
                <div class="video-item" onclick="loadAndPlayVideo('videos/video4.mp4')">
                    <h3 class="video-item-title">v4</h3>
                    <p>男厕所世界大战<br>(拍摄于2025.12.18)</p>
                </div>

                <!-- 视频5 -->
                <div class="video-item" onclick="loadAndPlayVideo('videos/video5.mp4')">
                    <h3 class="video-item-title">v5</h3>
                    <p>书接上回<br>(拍摄于2025.12.18)</p>
                </div>
            </div>
        </section>
    </div>

    <!-- 页脚 -->
    <footer>
        <p>© 2025 NY2026十四班逆天视频网站 | 官方精选</p>
        <p><a href="https://github.com/Jin-Mukun/ny202614" target="_blank"
                rel="noopener noreferrer">本网站开源：https://github.com/Jin-Mukun/ny202614</a></p>
    </footer>

    <script>
        // 视频播放器引用
        const videoPlayer = document.getElementById('main-video');
        const videoTitleElement = document.getElementById('current-video-title');
        const loadingStatus = document.getElementById('loading-status');
        const loadingBar = document.getElementById('loading-bar');
        const loadingProgress = document.getElementById('loading-progress');

        // 防止快速连续点击的变量
        let isLoading = false;
        let stalledCount = 0;
        const MAX_STALLED_RETRIES = 3;

        // 视频路径 -> 显示标题 的映射表
        const TITLE_MAP = {
            'videos/video1.mp4': '入站必刷',
            'videos/video2.mp4': '扫地机器人测评',
            'videos/video3.mp4': '战神反击战1',
            'videos/video4.mp4': '厕所二战',
            'videos/video5.mp4': '战神反击战2'
        };

        // 简化的主播放函数 - 解决播放中断问题
        function loadAndPlayVideo(videoSrc, videoTitle) {
            // 防止快速连续点击
            if (isLoading) return;

            // 验证视频源
            if (!videoSrc || typeof videoSrc !== 'string') {
                console.error('无效的视频源:', videoSrc);
                return;
            }

            isLoading = true;
            stalledCount = 0; // 重置缓冲失败计数

            // 立即更新标题：优先使用传入参数，其次使用映射表，最后回退到未知
            const mappedTitle = TITLE_MAP[videoSrc];
            const titleToShow = videoTitle || mappedTitle || '未知视频';
            videoTitleElement.textContent = titleToShow;

            // 简化的视频切换逻辑
            try {
                // 1. 暂停当前播放
                videoPlayer.pause();

                // 2. 更新 <source> 元素的 src（更兼容于某些浏览器实现）；若不存在则回退到直接设置 video.src
                const sourceEl = videoPlayer.querySelector('source');
                if (sourceEl) {
                    sourceEl.setAttribute('src', videoSrc);
                } else {
                    videoPlayer.src = videoSrc;
                }

                // 3. 显示加载状态
                showLoadingStatus();

                // 4. 加载新视频（在更新 <source> 后调用）
                try {
                    videoPlayer.load();
                } catch (loadErr) {
                    // 有些环境可能在同步调用 load 时抛出，记录但继续执行
                    console.warn('调用 load() 时遇到问题:', loadErr);
                }

                // 5. 尝试重置播放位置；如果在元数据加载前设置会抛错，则在 loadedmetadata 后再设置一次
                try {
                    videoPlayer.currentTime = 0;
                } catch (e) {
                    console.warn('无法立即设置 currentTime，等待元数据加载后重置:', e);
                    const onLoadedMeta = function () {
                        try { videoPlayer.currentTime = 0; } catch (err) { /* 忽略 */ }
                        videoPlayer.removeEventListener('loadedmetadata', onLoadedMeta);
                    };
                    videoPlayer.addEventListener('loadedmetadata', onLoadedMeta);
                }

            } catch (error) {
                console.error('切换视频时出错:', error);
                hideLoadingStatus();
                videoTitleElement.textContent = videoTitle + ' (加载失败)';
                isLoading = false;
                stalledCount = 0;
            }
        }

        // 显示加载状态
        function showLoadingStatus() {
            loadingStatus.textContent = '正在加载...';
            loadingBar.style.display = 'block';
            loadingProgress.style.width = '0%';
        }

        // 隐藏加载状态
        function hideLoadingStatus() {
            loadingBar.style.display = 'none';
            loadingProgress.style.width = '100%';

            // 使用requestAnimationFrame确保状态更新
            requestAnimationFrame(() => {
                loadingStatus.textContent = '准备就绪';
            });
        }

        // 视频事件监听器集合
        function setupVideoEventListeners() {
            // 监听加载进度
            videoPlayer.addEventListener('progress', function () {
                if (videoPlayer.buffered.length > 0 && videoPlayer.duration > 0) {
                    try {
                        const bufferedEnd = videoPlayer.buffered.end(videoPlayer.buffered.length - 1);
                        const duration = videoPlayer.duration;
                        if (duration !== Infinity && duration > 0) {
                            const progressPercent = (bufferedEnd / duration) * 100;
                            if (!isNaN(progressPercent)) {
                                loadingProgress.style.width = Math.min(progressPercent, 100) + '%';
                            }
                        }
                    } catch (error) {
                        console.warn('计算加载进度时出错:', error);
                    }
                }
            });

            // 监听网络缓冲状态
            videoPlayer.addEventListener('waiting', function () {
                if (loadingBar.style.display !== 'none') {
                    loadingStatus.textContent = '缓冲中...';
                }
            });

            videoPlayer.addEventListener('canplay', function () {
                if (loadingBar.style.display !== 'none') {
                    loadingStatus.textContent = '可以播放';
                }
            });

            videoPlayer.addEventListener('playing', function () {
                hideLoadingStatus();
                stalledCount = 0; // 重置缓冲失败计数
            });

            // 元数据加载完成
            videoPlayer.addEventListener('loadedmetadata', function () {
                hideLoadingStatus();
                isLoading = false;
            });

            // 视频结束处理
            videoPlayer.addEventListener('ended', function () {
                loadingStatus.textContent = '播放完成';
                setTimeout(() => {
                    loadingStatus.textContent = '准备就绪';
                }, 2000);
            });

            // 错误处理
            videoPlayer.addEventListener('error', function (e) {
                console.error('视频加载错误:', e, '错误代码:', (videoPlayer.error && videoPlayer.error.code));

                let errorMsg = '视频加载失败';
                if (videoPlayer.error) {
                    switch (videoPlayer.error.code) {
                        case 1:
                            errorMsg = '视频加载被中止';
                            break;
                        case 2:
                            errorMsg = '网络错误，请检查连接';
                            break;
                        case 3:
                            errorMsg = '视频格式不支持';
                            break;
                        case 4:
                            errorMsg = '视频源不可用';
                            break;
                        default:
                            errorMsg = '未知错误';
                    }
                }

                videoTitleElement.textContent = errorMsg;
                hideLoadingStatus();
                isLoading = false;
                stalledCount = 0; // 重置计数
            });

            // 添加视频缓冲监听，防止播放中断
            videoPlayer.addEventListener('stalled', function () {
                stalledCount++;
                console.warn('视频缓冲中断，第' + stalledCount + '次尝试重新加载...');

                if (stalledCount <= MAX_STALLED_RETRIES) {
                    if (!isLoading) {
                        showLoadingStatus();
                        loadingStatus.textContent = '缓冲中断，重新加载...';

                        // 尝试重新加载
                        setTimeout(() => {
                            videoPlayer.load();
                        }, 1000);
                    }
                } else {
                    console.error('视频缓冲多次失败，停止重试');
                    loadingBar.style.display = 'none';
                    loadingProgress.style.width = '100%';
                    requestAnimationFrame(() => {
                        loadingStatus.textContent = '网络连接不稳定，请检查网络后重试';
                    });
                    isLoading = false;
                }
            });

            // 监听加载数据状态
            videoPlayer.addEventListener('loadstart', function () {
                console.log('开始加载视频数据');
                showLoadingStatus();
            });

            // 监听可播放数据
            videoPlayer.addEventListener('canplaythrough', function () {
                console.log('视频完全缓冲完成');
                hideLoadingStatus();
                isLoading = false;
                stalledCount = 0; // 重置计数
            });
        }

        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 确保视频元素存在
            if (!videoPlayer || !videoTitleElement) {
                console.error('关键元素未找到');
                return;
            }

            // 设置视频事件监听器
            setupVideoEventListeners();

            // 初始加载状态
            showLoadingStatus();

            // 只设置playsinline，不重复设置preload
            videoPlayer.setAttribute('playsinline', 'true');

            // 同步列表中的标题为 TITLE_MAP 中的值（以映射为准）
            try {
                const items = document.querySelectorAll('.video-item');
                items.forEach(item => {
                    const onclick = item.getAttribute('onclick') || '';
                    const m = onclick.match(/'([^']+)'/);
                    const src = m ? m[1] : item.dataset.src;
                    if (src && TITLE_MAP[src]) {
                        const titleEl = item.querySelector('.video-item-title');
                        if (titleEl) titleEl.textContent = TITLE_MAP[src];
                    }
                });

                // 设置初始播放标题为映射值（如果存在）
                const initialSource = (videoPlayer.querySelector('source') && videoPlayer.querySelector('source').getAttribute('src')) || null;
                if (initialSource && TITLE_MAP[initialSource]) {
                    videoTitleElement.textContent = TITLE_MAP[initialSource];
                }
            } catch (e) {
                console.warn('同步标题时出错:', e);
            }

            console.log('视频网站初始化完成');
        });

        // 全局错误处理
        window.addEventListener('error', function (e) {
            console.error('全局错误:', e.error);
        });

        // 全局未处理的Promise拒绝
        window.addEventListener('unhandledrejection', function (e) {
            console.error('未处理的Promise拒绝:', e.reason);
            e.preventDefault(); // 防止在控制台显示错误
        });
    </script>
</body>

</html>
